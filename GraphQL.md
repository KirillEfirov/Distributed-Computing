# Что такое GraphQL и зачем он понадобился?

GraphQL — это язык запросов и серверная среда для API с открытым исходным кодом. Он появился в Facebook в 2012 году и был разработан для упрощения управления конечными точками для API на основе REST.

В 2015 году код GraphQL стал открытым, и сейчас GraphQL используют Airbnb, GitHub, Pinterest, Shopify и многие другие компании.

Когда разработчики Facebook создавали мобильное приложение, они искали способы ускорить работу. Была трудность: при одновременном запросе из различных по типу баз данных, например из облачной Redis и MySQL, приложение ужасно тормозило. Для решения задачи в Facebook придумали собственный язык запросов, который обращается к конечной точке и упрощает форму запрашиваемых данных. Особенно это было актуально для соц-сети, где много связей и запросов по связанным элементам — например, получить посты всех подписчиков пользователя X.

# Преимущества GraphQL

- GraphQL позволяет клиентам запрашивать только те данные, которые им нужны, и получать их в одном запросе, что делает коммуникацию более эффективной.
- В GraphQL единая конечная точка для всех запросов, и схема API определяется на стороне сервера. Это делает API более гибким и облегчает его развитие.
- GraphQL позволяет выразить связи между данными и получать все необходимые данные в одном запросе.

[Преимущества перед REST](./REST.md#проблемы-rest)

В классическом REST API, чтобы получить такие данные, пришлось бы сделать несколько запросов к серверу: один запрос к эндпойнту пользователей для получения списка пользователей и запрос к энпойнту постов, у которого мы запросим посты для всех найденных пользователей (либо вообще по одному запросу на каджого нужного пользователя — но это реже). С использованием GraphQL эта проблема может быть решена более эффективно. Можно запросить список пользователей и, одновременно, указать, что для каждого пользователя нужно получить последние посты.

Пример запроса в GraphQL может выглядеть так, где мы запрашиваем 5 последних постов пользователей:
```graphql
query {
  users {
    id
    name
    posts(last: 5) {
      id
      text
      timestamp
    }
  }
}
```

А благодаря чему так происходит? Именно благодаря структуре GraphQL. Почему он Graph? Потому что он представляет собой структуру данных в виде графа, где узлы графа представляют собой объекты, а рёбра - связи между этими объектами. Это отражает способ организации данных и запросов в GraphQL, где клиенты могут запрашивать связанные данные, а также только те данные, которые им нужны.

# Недостатки

- Управление версиями

По мере развития API их структуры данных и операции могут меняться. Клиенты, не знающие об этих изменениях, могут вывести из строя свои системы или допустить неизвестные ошибки.

Для решения этой проблемы в API REST часто используется функция определения версий в URL, например https://example.com/api/v1/person/12341. Однако управление версиями не является обязательным и может стать причиной ошибок.

Для GraphQL требуется обратная совместимость API. Таким образом, удаленные поля возвращают сообщение об ошибке, а поля с устаревшим тегом возвращают предупреждение.



# Типы запросов GraphQL

Типы запросов в GraphQL сводятся к основным трём:

* Query

C помощью Query GraphQL получает необходимые данные с сервера. Тип запроса Query в GraphQL — аналог GET в REST. Запросы — строки, которые отправляются в теле HTTP POST-запроса.

> Обратите внимание, все типы запросов в GraphQL отправляются через POST. Но это если мы говорим про обмен по HTTP, и это самый распространённый вариант. Но GraphQL также может работать и через Веб-сокеты, и через gRPC, и поверх других транспортных протоколов.

Примеры Query мы уже видели, но давайте ещё раз для закрепления: получим параметры fname и age всех пользователей:

```graphql
query {
  users {
    fname
    age
  }
}
```

В ответ на этот запрос сервер присылает данные в формате JSON. Структура ответа соответствует структуре запроса:

```json
data : {
  users [
    {
      "fname": "Joe",
      "age": 23
    },
    {
      "fname": "Betty",
      "age": 29
    }
  ]
}
```

* Mutation

```graphql
mutation createUser{
  addUser(fname: "Richie", age: 22) {
    id
  }
}
```

Здесь создаётся мутация createUser, которая добавляет в БД пользователя с fname Richie и age 22. В ответ на этот запрос сервер присылает JSON с id записи. Ответ выглядит так:

```json
data : {
addUser : "a36e4h"
}
```

* Subscribtion

С помощью подписок клиент слушает изменения в БД в режиме реального времени. Под капотом подписки используют Веб-сокеты. Пример кода:

```graphql
subscription listenLikes {
  listenLikes {
    fname
    likes
  }
}
```

С помощью этого запроса можно, например, получать список пользователей с именами и количеством лайков каждый раз, когда оно меняется.

Например, когда пользователь с fname Richie получает лайк, ответ будет таким:

```json
data: {
listenLikes: {
    "fname": "Richie",
    "likes": 245
  }
}
```

# Краткое описание различий REST и GraphQL

|                     | REST                    | GraphQL       |
|---------------------|-------------------------|---------------|
| Что это             | REST – это набор правил, определяющих структурированный обмен данными между клиентом и сервером.| GraphQL – это язык запросов, архитектурный стиль и набор инструментов для создания API и управления ими.|
|Лучше всего подходит для|REST подходит для простых источников данных, где ресурсы четко определены.| GraphQL подходит для больших, сложных и взаимосвязанных источников данных.|
|Доступ к данным|В REST имеется несколько адресов в виде URL-адресов для определения ресурсов.|В GraphQL имеется один адрес в виде URL-адреса.|
|Объем возвращенных данных|REST возвращает данные в фиксированной структуре, определенной сервером.|GraphQL возвращает данные в гибкой структуре, определенной клиентом.|
|Структурирование и определение данных|Данные REST слабо типизированы. Поэтому клиент должен решить, как интерпретировать отформатированные данные при их возврате.|Данные GraphQL строго типизированы. Таким образом, клиент получает данные в заранее определенных и взаимно понятных форматах.|
|Проверка ошибок|При использовании REST клиент должен проверить правильность возвращаемых данных.|В GraphQL недействительные запросы обычно отклоняются структурой схемы. В результате появляется автоматически сгенерированное сообщение об ошибке.|
