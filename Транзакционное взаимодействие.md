# Транзакционное взаимодействие

> Определение: Транзакцией называется последовательность операций, выполняемая системой, как единое целое.

Транзакции превращают процессы доступа и модификации множества элементов данных в одну атомарную операцию. Если в процессе выполнения транзакции будет определено, что дальнейшее ее выполнение невозможно (по любой причине), все данные восстанавливаются с теми значениями и в том состоянии, в котором они были до начала транзакции. Это свойство называется "все или ничего".

Делая транзакционные вызовы, можно не беспокоиться о состоянии вызова или взаимодействия, если в процессе их выполнения произошла ошибка. Если приложение или какая-нибудь его часть не срабатывает, транзакционные гарантии означают, что не возникнет никаких нежелательных побочных эффектов.

> Чтобы транзакции действительно выполняли свою роль, они должны выполнять предъявляемые требования [ACID](./ACID.md)

# Реализация распределенных транзакций

**Протокол двухфазного подтверждения (2PC)** строится из двух фаз, каждая из которых включает в себя два шага. Первая фаза называется фазой голосования и состоит из шагов 1 и 2, вторая фаза (фаза решения) состоит из шагов 3 и 4 (Рис. 2.10):

1. Координатор рассылает участникам запрос голосования.
2. Участник после получения запроса подает свой голос координатору о том, что он готов подтвердить свою часть транзакции (проголосовать "за"), либо отказаться от такого подтверждения (проголосовать "против").
3. Координатор собирает ответы всех участников. Если все участники подтвердили транзакцию, координатор начинает выполнять соответствующие действия и посылает всем участникам свое решение – провести подтверждение транзакции. Однако если хотя бы один участник отказался подтвердить свою часть транзакции, координатор рассылает всем указание отмены транзакции.
4. Если участник, проголосовавший за подтверждение, получает подтверждение от координатора, он подтверждает транзакцию (выполняет свои внутренние действия по ее завершению). В случае же получения указания отмены выполнение транзакции прекращается.

<p align='center'>
  <img src=./images/реализация-распределенных-транзакций.png
       alt="обмен сообщениями">
</p>

Если в работе координатора возникнет ошибка, работа протокола нарушается, поскольку другие процессы будут бесконечно ожидать сообщений. Для исправления ситуации вводится механизм **тайм-аута**. Если в течение некоторого времени сообщения о сводных результатах голосования от координатора не поступают прочим участникам, они приходят к выводу о необходимости прервать свою работу и послать координатору сообщение об отказе от подтверждения (проголосовав "против").

Из-за сбоев в работе самого координатора для протокола 2РС (Протокол двухфазного подтверждения) характерно наличие ситуации, когда участнику приходится блокироваться до восстановления работоспособности этого координатора. Такая ситуация возникает, когда все участники успевают получить запрос голосования, но после этого координатор выходит из строя. В этом случае участники даже совместно не состоянии решить, каким образом продолжить работу далее. По этой причине протокол 2РС называется протоколом блокирующего подтверждения. В таких случаях решение о разблокировке передается системному администратору, который подтверждает или отвергает транзакцию и согласовывает состояние системы после восстановления координатора.

Основная цель транзакционного монитора – поддержка выполнения распределенных транзакций. Традиционный удаленный вызов процедуры изначально был разработан для того, чтобы одна клиентская программа могла обратиться к одному серверу. Когда процесс взаимодействия усложняется (например, клиент вызывает процедуры с двух серверов, или клиент общается с сервером, который взаимодействует с базой данных), традиционный удаленный вызов неверно трактует вложенные вызовы как независимые друг от друга. Лучшим решением является сделать вызов процедуры транзакционным.

<p align='center'>
  <img src=./images/выполнение-удаленного-вызова-внутри-транзакции.png
       alt="Выполнение удаленного вызова внутри транзакционных скобок">
</p>

где Т – транзакция; BOT, EOT – открывающая и закрывающая транзакционные скобки.
